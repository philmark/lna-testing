<html>
  <head></head>
  <body>
    <div class="lnaState">LNA State: unknown</div>

    <button onclick="runFetch()">Trigger query</button>

    <!-- <button onclick="runFetch( { withSW: true })">Trigger query intercepted by service worker</button> -->
    <div id="results"></div>

    <script>
      // Register SW
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("sw.js", { scope: "./" })
          .then((reg) => console.log("SW registered:", reg.scope))
          .catch((err) => console.log("SW registration failed:", err));
      }

      // Show LNA Permission
      async function getLNAState() {
        try {
          const permission = await navigator.permissions.query({
            name: "local-network-access",
          });

          const el = document.querySelector(".lnaState");
          el.textContent = `LNA State: ${permission.state}`;

          permission.onchange = () => {
            el.textContent = `LNA State: ${permission.state}`;
            console.log("LNA state changed:", permission.state);
          };
        } catch (error) {
          console.error("Error querying LNA permission:", error);
        }
      }

      window.addEventListener("load", getLNAState);

      // Simple logger
      function appendResult(text) {
        const r = document.getElementById("results");
        const div = document.createElement("div");
        div.textContent = text;
        r.appendChild(div);
      }

      // Run request
      function runFetch( { withSW = false } = {}) {
        const url = "http://localhost:8000";
        const options = {
          method: 'get',
          mode: 'cors',
          cache: 'no-cache',
          headers: withSW ? {
            'X-Use-SW': 'true'
          } : {}
        };
        return fetch(url, options)
          .then((response) => {
            appendResult(`Response received (status ${response.status})`);
          })
          .catch((error) => {
            appendResult(`Error: ${error}`);
          });
      }
    </script>
  </body>
</html>
